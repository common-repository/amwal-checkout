(()=>{"use strict";var t=function(t,e,o,i){return new(o||(o=Promise))((function(r,n){function d(t){try{c(i.next(t))}catch(t){n(t)}}function s(t){try{c(i.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(d,s)}c((i=i.apply(t,e||[])).next())}))};const e=t=>{const e=new r(t);if(e.registerEventListeners(),"amwal-product-page"===e.position){const e=jQuery("form.variations_form");null==e||e.on("show_variation",(function(){t.disabled=!1})),null==e||e.on("hide_variation",(function(){t.disabled=!0}))}};function o(){document.querySelectorAll("amwal-checkout-button").forEach(e)}document.addEventListener("DOMContentLoaded",(function(){o()}));const i=jQuery(document.body);i.on(AMWALWC_CONSTANTS.extraEvents,o),i.on("added_to_cart",(()=>{document.querySelectorAll(".amwal-product-page amwal-checkout-button").forEach((t=>{t.remove()}))})),window.onbeforeunload=function(){document.querySelectorAll("amwal-checkout-button").forEach((t=>{t.disabled=!0}))};class r{constructor(t){var e,o;this.handlingPrePayTrigger=!1,this.handlingCheckoutPayTrigger=!1,this.busyUpdatingOrder=!1,this.receivedSuccess=!1,this.checkoutButton=t,this.buttonId=this.checkoutButton.getAttribute("ref-id"),this.position=this.checkoutButton.getAttribute("position"),this.orderContent=void 0,this.busyUpdatingOrder=!1,this.receivedSuccess=!1,this.backendURL=AMWALWC_CONSTANTS.transactionDetailsURL,this.pre_existing_order_id=null!==(o=null===(e=this.checkoutButton)||void 0===e?void 0:e.getAttribute("checkout-order-id"))&&void 0!==o?o:void 0,this.buttonVersion=AMWALWC_CONSTANTS.pluginVersion}registerEventListeners(){this.checkoutButton.getAttribute("events-registered")||(this.checkoutButton.addEventListener("amwalCheckoutSuccess",(t=>{if(this.receivedSuccess=!0,!this.busyUpdatingOrder)try{t.detail.orderId&&this.genOrderId&&(window.location.href=AMWALWC_CONSTANTS.siteURL+"?amwal_order_created="+this.genOrderId)}catch(t){throw new Error(null==t?void 0:t.toString())}}),!1),this.checkoutButton.addEventListener("updateOrderOnPaymentsuccess",(t=>{this.busyUpdatingOrder=!0,t.detail.orderId&&this.completeOrder().then((()=>{this.busyUpdatingOrder=!1,this.receivedSuccess&&this.genOrderId&&(window.location.href=AMWALWC_CONSTANTS.siteURL+"?amwal_order_created="+this.genOrderId)})).catch((t=>{throw new Error(null==t?void 0:t.toString())}))}),!1),this.checkoutButton.addEventListener("amwalAddressUpdate",(e=>{const o=AMWALWC_CONSTANTS.siteURL+"/wp-json/wc/amwal/v2/checkout/update";n(o,{amwal_cart_id:this.buttonId,address_details:e.detail}).then((e=>t(this,void 0,void 0,(function*(){return yield e.json()})))).then((t=>{this.checkoutButton.setAttribute("discount",t.discount),this.checkoutButton.setAttribute("taxes",t.taxes),this.checkoutButton.setAttribute("amount",t.amount),this.checkoutButton.setAttribute("shipping-methods",JSON.stringify(t.shipping_methods)),this.checkoutButton.shippingMethods=t.shipping_methods,this.checkoutButton.dispatchEvent(new Event("amwalAddressAck"))})).catch((t=>{this.checkoutButton.dispatchEvent(new CustomEvent("amwalAddressTriggerError",{detail:{description:"Error in getting shipping methods",error:null==t?void 0:t.toString()}}))}))}),!1),this.checkoutButton.addEventListener("amwalDismissed",(t=>{t.detail.orderId&&(this.genOrderId&&this.completeOrder(t.detail.paymentSuccessful).catch((t=>{throw new Error(null==t?void 0:t.toString())})),this.checkoutButton.disabled=!0,this.cancelOrder(t.detail.orderId).finally((()=>{this.checkoutButton.disabled=!1,this.genOrderId=void 0})))}),!1),this.checkoutButton.addEventListener("amwalPrePayTrigger",(e=>{if(this.handlingPrePayTrigger)return;if(this.handlingPrePayTrigger=!0,"amwal-before-checkout-form"===this.position&&!this.pre_existing_order_id)throw new Error("Unexpected error occurred while creating order");const o=AMWALWC_CONSTANTS.siteURL+"/wp-json/wc/amwal/v2/order/create";n(o,{amwal_cart_id:this.buttonId,transaction_details:e.detail,amwal_order_id:this.pre_existing_order_id}).then((e=>t(this,void 0,void 0,(function*(){const t=yield e.json();if(console.log("amwalPrePayTrigger",e,t),!e.ok)throw new Error("Internal server error while creating order");return t})))).then((t=>{var e,o,i;this.genOrderId=t.order_id,this.checkoutButton.setAttribute("amount",t.amount),this.checkoutButton.dispatchEvent(new CustomEvent("amwalPrePayTriggerAck",{detail:{order_total_amount:t.amount,order_id:t.order_id,card_bin_additional_discount_message:null!==(e=t.card_bin_additional_discount_message)&&void 0!==e?e:"",card_bin_additional_discount:null!==(o=t.card_bin_additional_discount)&&void 0!==o?o:0,old_amount:null!==(i=t.old_amount)&&void 0!==i?i:0}}))})).catch((t=>{this.checkoutButton.dispatchEvent(new CustomEvent("amwalPrePayTriggerError",{detail:{description:null==t?void 0:t.toString()}}))})).finally((()=>{this.handlingPrePayTrigger=!1}))}),!1),this.checkoutButton.addEventListener("amwalPreCheckoutTrigger",(e=>{this.handlingCheckoutPayTrigger||(this.handlingCheckoutPayTrigger=!0,("amwal-product-page"===this.position?d().then((()=>t(this,void 0,void 0,(function*(){yield this.createCheckout()})))):this.createCheckout()).then((()=>{var t;const e=null===(t=this.checkoutButton)||void 0===t?void 0:t.getAttribute("amount");if(!(this.orderContent&&this.checkoutButton&&e&&parseFloat(e)>0))throw new Error("Cannot Proceed With Amount Of Zero");this.checkoutButton.dispatchEvent(new CustomEvent("amwalPreCheckoutTriggerAck",{detail:{order_position:this.position,order_content:JSON.stringify(this.orderContent),plugin_version:this.buttonVersion?"woocommerce "+this.buttonVersion:void 0}}))})).catch((t=>{this.checkoutButton.dispatchEvent(new CustomEvent("amwalPreCheckoutTriggerError",{detail:{description:null==t?void 0:t.toString()}}))})).finally((()=>{this.handlingCheckoutPayTrigger=!1})))}),!1),this.checkoutButton.setAttribute("events-registered","true"))}createCheckout(){return t(this,void 0,void 0,(function*(){const t=AMWALWC_CONSTANTS.siteURL+"/wp-json/wc/amwal/v2/checkout/create",e=yield n(t,{amwal_cart_id:this.buttonId,pre_existing_order_id:this.pre_existing_order_id}),o=yield e.json();this.checkoutButton.setAttribute("taxes",o.taxes),this.checkoutButton.setAttribute("amount",o.amount),this.checkoutButton.setAttribute("discount",o.discount),this.orderContent=o.order_content}))}cancelOrder(e){return t(this,void 0,void 0,(function*(){if("amwal-product-page"===this.position){const t=AMWALWC_CONSTANTS.siteURL+"/wp-json/wc/amwal/v2/orders/cancel";return yield n(t,{amwal_cart_id:this.buttonId,amwal_transaction_id:e})}}))}completeOrder(e=!0){var o,i,r;return t(this,void 0,void 0,(function*(){const t=null!==(r=null!==(i=null===(o=this.checkoutButton)||void 0===o?void 0:o.getAttribute("checkout-order-id"))&&void 0!==i?i:this.genOrderId)&&void 0!==r?r:"",d=AMWALWC_CONSTANTS.siteURL+"/wp-json/wc/amwal/v2/order/complete";return yield n(d,{amwal_cart_id:this.buttonId,order_id:t,assert_transaction_status:e})}))}}const n=function(e,o){return t(this,void 0,void 0,(function*(){return yield fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})}))},d=()=>t(void 0,void 0,void 0,(function*(){var t;const e=document.querySelector("form.cart");if(null==e)throw new Error("Product form not found");const o=null!==(t=e.getAttribute("action"))&&void 0!==t?t:window.location.href;if(!o)throw new Error("Product form URL not found");const i=document.querySelector("form.cart button[type='submit']");if(!i)throw new Error("Submit button not found");const r=i.value,n=new FormData(e),d=Object.assign({"add-to-cart":r},Object.fromEntries(n.entries()));yield s(o,d)})),s=(e,o)=>t(void 0,void 0,void 0,(function*(){yield new Promise(((t,i)=>{jQuery.ajax({url:e,type:"POST",data:o,success:function(e){if((null==e?void 0:e.indexOf("woocommerce-error"))>0){const t=(new DOMParser).parseFromString(e,"text/html").querySelectorAll(".woocommerce-error li"),o=[];if(t.forEach((t=>{var e,i;o.push(null!==(i=null===(e=t.textContent)||void 0===e?void 0:e.trim())&&void 0!==i?i:"")})),o.length>0)return void i(new Error(o.join("\n")))}t()},error:function(){i(new Error("ajax adding to cart error"))}})}))}))})();